# 쓰레드의 이해

* Light Weight Process 라고도 함
* 프로세스
  * 프로세스 간에는 데이터 접근이 불가 그래서 ipc를 사용
* 스레드
  * 하나의 프로세스에 여러 스레드
  * 스레드는 동시 실행 가능
  * 프로세스의 데이터를 모두 접근 가능
  * 스레드는 각 스택영역을 가짐

스택은 함수 호출시 전달되는 인자, 되돌아갈 주소값 및 함수 내에서 선언하는 변수 등을 저장하기 위해 사용되는 메모리 공간이다. 스택 메모리 공간이 독립적이라는 것은 독립적인 함수 호출이 가능하다는 것이고, 이는 독립적인 실행흐름이 추가되는 것이다. 결과적으로 실행흐름의 추가를 위한 최소 조건이 독립된 스택을 제공하는 것이다.

프로세스에서 스택은 아래로 증가하고 힙은 위로 증가한다.   
스택과 힙 사이에 여유공간이 있는데 이건 멀티 스레드 작업을 할 때 각 스레드 별로 영역을 나눠서 주어준다

<img src="https://user-images.githubusercontent.com/72545732/143032601-c024ec8a-ad98-4d3a-a3b0-d52a3a923c99.png">

**멀티 프로세싱을 할때 하나의 태스크를 여러 스레드로 만들어서 동시에 실행해 버린다**

### Thread 장점

1. 사용자에 대한 응답성 향상 (서버에서 요청에 대한 스레드를 복수개를 만들어 threadA 는 특정작업, threadB 는 사용자와 커뮤니케이션을 하는등 할 수 있다)
2. 자원 공유 효율 
   1. IPC 기법과 같이 프로세스간 복잡한 소통 방식이 없음
   2. 프로세스 안에 있으므로 프로세스의 데이터를 모두 접근 가능
3. 작업이 분리되어 코드가 간결(사실 작성하기 나름)

### Thread 단점
1. 스레드 중 한 스레드만 문제가 있어도 전체 프로세스가 영향을 받음
2. 스레드를 많이 생성하면 context switching이 많이 일어나, 성능 저하
   1. 스레드가 많아지면 모든 스레드를 스케쥴링해야 하므로, Context Switching이 빈번하게 된다

### Thread vs Process
* 프로세스는 자신만의 주소영역을 가짐, 스레드는 주소영역 공유
* 프로세스는 독립적, 스레드는 프로세스의 서브셋

### 동기화 이슈
스레드들 간에 하나의 데이터에 접근하게 되면 프로그램의 실행 순서에 따라 데이터의 정보가 달라질 수 있다.    
멀티 스레드 작업에서 동기화 이슈는 필히 해결해야할 이슈

자 예시로 든 내용은 100000번 더해주는 로직이다.   
근데 만번 햇을때는 이상이 없는데 10만번 했을때는 이상이 있다.   
스레드간에 컨텍스트 스위칭이 일어나는 것이 핵심인데.    
이 컨텍스트 스위칭이 일어나는 주기가 있다.   
만번 계산 했을때는 이 주기안에 끝나서 global 변수 값에 저장까지 되었는데.   
십만번 계산 했을때는 계산 혹은 저장전에 주기가 돌아와서 값이 갱신이 되지 않는 경우가 생겨버린거다.   

그래서 계산 로직이 끝나기 전에 컨텍스트 스위칭이 일어나지 않도록 해주는 방법이 필요하다(ex. `lock.acquire()`, `lock.release()`, 임계영역)   

<img src="https://user-images.githubusercontent.com/72545732/143035242-9a43e973-3dfb-4f7f-844a-4cf1d7f33894.png">

* 동기화: 작업들 사이에 실행 시기를 맞추는 것

### 동기화 이슈 해결방안
* 상호배제: 스레드 하나가 공유 변수를 갱신하고 있을때 다른 스레드의 접근을 막아라!!!

### Mutex와 세마포어
* Mutex
  * 임계 구역에 하나의 스레드만 들어갈 수 있다
* Semaphore 
  * 임계 구역에 여러개의 스레드가 들어갈 수 있다
  * counter를 두어서 동시에 리소스에 접근 할 수 있는 허용 가능한 스레드 수를 제어

### 교착상태(Deadlock)과 기아상태(Starvation)

참고: 교착상태 발생조건
1. 상호배제 : 프로세스들이 필요한 자원에 대해 각자의 통제권을 요구한다.
2. 점유대기 : 프로세스가 할당된 자원을 가진 상태에서 다른 자원을 기다린다
3. 비선점 : 프로세스가 다른 프로세스의 자원을 뺏을수 없다
4. 순환대기 : 각 프로세스가 순환적으로 다음 프로세스가 요구하는 자원을 가지고 있다.

기아상태
* 특정 프로세스의 우선순위가 낮아서 원하는 자원을 계속 할당 받지 못하는 상태
* 교착상태는 동일한 자원을 여러 프로세스가 요청할 때 발생
* 기아상태는 부족한 자원을 여러 프로세스가 점유하기 위해 경쟁할 때 발생
